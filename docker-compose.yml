version: '3.8'

services:
  db:
    image: mysql:9.0
    container_name: guac-mysql
    restart: unless-stopped
    user: "1000:1000"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - ./mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${MYSQL_USER}", "-p${MYSQL_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILE:-3}
    networks:
      - guac-net

  guacd-init:
    image: guacamole/guacd:1.6.0
    container_name: guac-guacd-init
    entrypoint: /bin/sh -c "mkdir -p /var/lib/guacamole/recordings /var/lib/guacamole/typescripts && chown 1001:1001 /var/lib/guacamole/recordings /var/lib/guacamole/typescripts && chmod 770 /var/lib/guacamole/recordings /var/lib/guacamole/typescripts"
    volumes:
      - ./recordings:/var/lib/guacamole/recordings
      - ./recordings:/var/lib/guacamole/typescripts
    networks:
      - guac-net

  guacd:
    image: guacamole/guacd:1.6.0
    container_name: guac-guacd
    restart: unless-stopped
    environment:
      - GUACD_LOG_LEVEL=debug  # Increased for troubleshooting
    volumes:
      - ./recordings:/var/lib/guacamole/recordings
      - ./recordings:/var/lib/guacamole/typescripts
    depends_on:
      - guacd-init
    logging:
      driver: json-file
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILE:-3}
    networks:
      - guac-net

  guacamole:
    image: guacamole/guacamole:1.6.0
    container_name: guac-guacamole
    restart: unless-stopped
    environment:
      # DB connection
      - MYSQL_HOSTNAME=db
      - MYSQL_PORT=${MYSQL_PORT:-3306}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      # guacd connection
      - GUACD_HOSTNAME=guacd
      - GUACD_PORT=${GUACD_PORT:-4822}
      # Proxy support (for NGINX)
      - REMOTE_IP_VALVE_ENABLED=true
      - PROXY_ALLOWED_IPS_REGEX=^(10\.|172\.1[6789]\.|192\.168\.)
      # Recording extension
      - RECORDING_ENABLED=true
      - GUACAMOLE_RECORD_PATH=/var/lib/guacamole/recordings
      - GUACAMOLE_TYPESCRIPT_PATH=/var/lib/guacamole/typescripts
    volumes:
      - ./recordings:/var/lib/guacamole/recordings:ro
    depends_on:
      db:
        condition: service_healthy
      guacd:
        condition: service_started
    logging:
      driver: json-file
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILE:-3}
    networks:
      - guac-net

  nginx:
    image: nginx:1.28
    container_name: guac-nginx
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx-certs:/etc/nginx/certs:ro
    depends_on:
      - guacamole
    logging:
      driver: json-file
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILE:-3}
    networks:
      - guac-net

networks:
  guac-net:
    name: guac-net
    driver: bridge
